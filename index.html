<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>语音链接播放器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            warning: '#EF4444'
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .glass-effect { @apply bg-white/10 backdrop-blur-md border border-white/20; }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 to-indigo-950 text-white min-h-screen p-4 md:p-8">
  <div class="fixed top-0 left-0 right-0 bg-warning/90 text-center py-2 z-50">
    <p class="font-medium">内部信息严格保密，禁止外传给部门外使用</p>
  </div>

  <div class="max-w-5xl mx-auto pt-12">
    <header class="text-center mb-8 md:mb-12">
      <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">
        语音链接播放器
      </h1>
      <p class="text-slate-400 max-w-2xl mx-auto">支持播放速度调节（0.2-8倍）</p>
    </header>
    
    <main class="space-y-8">
      <!-- 音频链接区域 -->
      <section class="glass-effect rounded-xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fa fa-link text-primary mr-2"></i>音频链接
        </h2>
        <div class="flex flex-col md:flex-row gap-3">
          <input 
            type="text" 
            id="audioUrl" 
            value="http://cld-games3store-g60-10021.s3v2.nie.netease.com/20251109/game_10021/cc_audio_server/f63954a5-fc4f-4768-9ba4-af78882b26af?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Date=20251102T081635Z&X-Amz-SignedHeaders=host&X-Amz-Expires=604799&X-Amz-Credential=CWIA3R2W8DVABATD7EHD%2F20251102%2F%2Fs3%2Faws4_request&X-Amz-Signature=c34fd6b02a93b80bb4c873e2eca38182f4f09356619c2dba5f6c6209f6efa033" 
            class="flex-1 bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/50"
            placeholder="请输入音频链接"
          >
          <button 
            id="copyBtn" 
            class="bg-primary hover:bg-primary/80 text-white px-6 py-3 rounded-lg transition-all duration-300 flex items-center gap-2"
          >
            <i class="fa fa-copy"></i>复制
          </button>
        </div>
      </section>
      
      <!-- 播放器控制区域 -->
      <section class="glass-effect rounded-xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fa fa-play-circle text-primary mr-2"></i>播放控制
        </h2>
        
        <!-- 核心音频元素（可见化便于调试） -->
        <audio 
          id="audioPlayer" 
          controls 
          class="w-full mb-6 bg-slate-800/30 p-2 rounded-lg"
          preload="metadata"
        >
          您的浏览器不支持音频播放
        </audio>
        
        <div class="space-y-6">
          <!-- 播放/暂停/停止按钮组 -->
          <div class="flex justify-center gap-6">
            <button 
              id="playBtn" 
              class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-secondary hover:bg-secondary/80 flex items-center justify-center transition-all duration-300"
            >
              <i class="fa fa-play text-2xl md:text-3xl"></i>
            </button>
            <button 
              id="stopBtn" 
              class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-warning hover:bg-warning/80 flex items-center justify-center transition-all duration-300"
              disabled
            >
              <i class="fa fa-stop text-2xl md:text-3xl"></i>
            </button>
          </div>
          
          <!-- 音量控制 -->
          <div class="flex items-center gap-3">
            <i class="fa fa-volume-up text-green-400"></i>
            <label class="text-sm text-slate-400 min-w-[50px]">音量</label>
            <input 
              type="range" 
              id="volumeSlider" 
              min="0" 
              max="1" 
              step="0.05" 
              value="1" 
              class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"
            >
            <span class="text-sm text-green-400 w-[40px] text-right" id="volumeDisplay">100%</span>
          </div>
          
          <!-- 播放速度控制（0.2-8倍） -->
          <div class="flex items-center gap-3">
            <i class="fa fa-tachometer text-blue-400"></i>
            <label class="text-sm text-slate-400 min-w-[50px]">速度</label>
            <input 
              type="range" 
              id="speedSlider" 
              min="0.2" 
              max="8" 
              step="0.1" 
              value="1" 
              class="flex-1 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"
            >
            <span class="text-sm text-blue-400 w-[40px] text-right" id="speedDisplay">1.0x</span>
          </div>
          
          <!-- 声音强度检测 -->
          <div class="flex items-center gap-3">
            <i class="fa fa-signal text-slate-400"></i>
            <label class="text-sm text-slate-400 min-w-[50px]">强度</label>
            <div class="flex-1 h-3 bg-slate-700 rounded-full overflow-hidden">
              <div id="audioLevelBar" class="h-full bg-red-400 w-0 transition-all duration-200"></div>
            </div>
            <span id="audioLevelText" class="text-sm text-slate-400 w-[60px] text-right">未检测</span>
          </div>
        </div>
      </section>
      
      <!-- 错误日志区域 -->
      <section class="glass-effect rounded-xl p-6 shadow-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fa fa-exclamation-triangle text-warning mr-2"></i>错误日志
        </h2>
        
        <textarea 
          id="errorLog" 
          placeholder="无错误信息" 
          class="w-full h-32 bg-slate-800/50 border border-slate-700 rounded-lg px-4 py-3 focus:outline-none resize-none"
          readonly
        ></textarea>
        
        <div class="flex justify-end mt-4">
          <button 
            id="clearLogBtn" 
            class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg transition-all duration-300"
          >
            <i class="fa fa-trash mr-1"></i>清空
          </button>
        </div>
      </section>
    </main>
  </div>

  <script>
    // DOM元素
    const audioUrlInput = document.getElementById('audioUrl');
    const copyBtn = document.getElementById('copyBtn');
    const audioPlayer = document.getElementById('audioPlayer');
    const playBtn = document.getElementById('playBtn');
    const stopBtn = document.getElementById('stopBtn');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeDisplay = document.getElementById('volumeDisplay');
    const speedSlider = document.getElementById('speedSlider');
    const speedDisplay = document.getElementById('speedDisplay');
    const audioLevelBar = document.getElementById('audioLevelBar');
    const audioLevelText = document.getElementById('audioLevelText');
    const errorLog = document.getElementById('errorLog');
    const clearLogBtn = document.getElementById('clearLogBtn');

    // 状态变量
    let audioContext = null;
    let analyser = null;
    let isPlaying = false;

    // 初始化
    window.addEventListener('load', () => {
      // 绑定音频源到输入框
      updateAudioSource();
      // 监听链接变化
      audioUrlInput.addEventListener('input', updateAudioSource);
    });

    // 更新音频源
    function updateAudioSource() {
      const url = audioUrlInput.value.trim();
      if (url) {
        audioPlayer.src = url;
      }
    }

    // 播放/暂停切换
    playBtn.addEventListener('click', async () => {
      try {
        if (isPlaying) {
          // 暂停播放
          await audioPlayer.pause();
          playBtn.innerHTML = '<i class="fa fa-play text-2xl md:text-3xl"></i>';
          isPlaying = false;
        } else {
          // 开始播放（处理浏览器自动播放限制）
          const url = audioUrlInput.value.trim();
          if (!url) {
            logError('请输入有效的音频链接');
            return;
          }

          // 确保音频源正确
          if (audioPlayer.src !== url) {
            audioPlayer.src = url;
          }

          // 启动播放
          await audioPlayer.play();
          playBtn.innerHTML = '<i class="fa fa-pause text-2xl md:text-3xl"></i>';
          stopBtn.disabled = false;
          isPlaying = true;

          // 初始化声音强度检测
          initAudioAnalysis();
        }
      } catch (err) {
        // 捕获播放失败（如自动播放限制）
        logError(`播放失败：${err.message}，请检查链接或点击播放器控件重试`);
      }
    });

    // 停止播放
    stopBtn.addEventListener('click', () => {
      audioPlayer.pause();
      audioPlayer.currentTime = 0; // 重置播放进度
      playBtn.innerHTML = '<i class="fa fa-play text-2xl md:text-3xl"></i>';
      stopBtn.disabled = true;
      isPlaying = false;
      resetAudioAnalysis();
    });

    // 音量控制
    volumeSlider.addEventListener('input', () => {
      const volume = parseFloat(volumeSlider.value);
      audioPlayer.volume = volume;
      volumeDisplay.textContent = `${Math.round(volume * 100)}%`;
    });

    // 播放速度控制（0.2-8倍）
    speedSlider.addEventListener('input', () => {
      const speed = parseFloat(speedSlider.value);
      audioPlayer.playbackRate = speed; // HTML5音频原生支持速度调节
      speedDisplay.textContent = `${speed.toFixed(1)}x`;
    });

    // 初始化声音强度分析
    function initAudioAnalysis() {
      if (audioContext) return;

      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        
        // 直接从音频元素创建源（修复播放无响应的核心）
        const source = audioContext.createMediaElementSource(audioPlayer);
        source.connect(analyser);
        analyser.connect(audioContext.destination);

        // 实时更新强度
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        function updateLevel() {
          if (!analyser || !isPlaying) return;
          analyser.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((sum, val) => sum + val, 0) / bufferLength;
          const levelPercent = Math.min(100, Math.floor(average / 255 * 100));

          audioLevelBar.style.width = `${levelPercent}%`;
          if (levelPercent < 10) {
            audioLevelBar.className = 'h-full bg-red-400 w-0 transition-all duration-200';
            audioLevelText.textContent = `极低(${levelPercent}%)`;
            audioLevelText.className = 'text-sm text-red-400 w-[60px] text-right';
          } else if (levelPercent < 30) {
            audioLevelBar.className = 'h-full bg-yellow-400 w-0 transition-all duration-200';
            audioLevelText.textContent = `较低(${levelPercent}%)`;
            audioLevelText.className = 'text-sm text-yellow-400 w-[60px] text-right';
          } else {
            audioLevelBar.className = 'h-full bg-green-400 w-0 transition-all duration-200';
            audioLevelText.textContent = `正常(${levelPercent}%)`;
            audioLevelText.className = 'text-sm text-green-400 w-[60px] text-right';
          }
          requestAnimationFrame(updateLevel);
        }
        updateLevel();
      } catch (err) {
        logError(`音频分析初始化失败：${err.message}`);
      }
    }

    // 重置声音强度分析
    function resetAudioAnalysis() {
      if (analyser) {
        analyser.disconnect();
      }
      audioContext = null;
      analyser = null;
      audioLevelBar.style.width = '0%';
      audioLevelText.textContent = '未检测';
      audioLevelText.className = 'text-sm text-slate-400 w-[60px] text-right';
    }

    // 复制链接
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(audioUrlInput.value);
      } catch (err) {
        logError(`复制失败：${err.message}`);
      }
    });

    // 错误日志
    function logError(text) {
      const time = new Date().toTimeString().slice(0, 8);
      errorLog.value += `[${time}] ${text}\n`;
      errorLog.scrollTop = errorLog.scrollHeight;
    }

    // 清空日志
    clearLogBtn.addEventListener('click', () => {
      errorLog.value = '';
    });

    // 监听音频播放结束
    audioPlayer.addEventListener('ended', () => {
      playBtn.innerHTML = '<i class="fa fa-play text-2xl md:text-3xl"></i>';
      stopBtn.disabled = true;
      isPlaying = false;
      resetAudioAnalysis();
    });
  </script>
</body>
</html>
